format_version: "13"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: ios

trigger_map:
- push_branch: main
  workflow: primary
- push_branch: feature/*
  workflow: primary
- pull_request_target_branch: main
  workflow: primary

workflows:
  primary:
    description: "Main entry point that runs both backend and iOS tests"
    after_run:
    - test_backend
    - test_ios

  test_backend:
    description: "Build and test Go backend using Docker Compose"
    project_type: other
    stack: linux-docker-android-22.04
    steps:
    - activate-ssh-key@4: {}
    - git-clone@6: {}
    - script@1:
        title: Run Backend Tests
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            cd backend
            # Note: make test already handles docker-compose up/down
            make test

  test_ios:
    description: "Build and test iOS app using Mock Data"
    stack: osx-xcode-16.0.x
    steps:
    - activate-ssh-key@4: {}
    - git-clone@6: {}
    - xcode-test@5:
        title: Run iOS Tests (Unit + UI with Mocks)
        inputs:
        - project_path: ios/demoBank/demoBank.xcodeproj
        - scheme: demoBank
        - destination: platform=iOS Simulator,name=iPhone 16 Pro,OS=latest
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none

app:
  envs:
  - BITRISE_PROJECT_PATH: ios/demoBank/demoBank.xcodeproj
  - BITRISE_SCHEME: demoBank