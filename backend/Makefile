.PHONY: test clean wait-for-db

# DomyÅ›lne cele
all: test

# Czyszczenie Å›rodowiska: zatrzymuje kontenery i usuwa wolumeny
clean:
	@echo "ğŸ§¹ Cleaning up environment..."
	docker-compose down -v --remove-orphans
	@# Opcjonalnie: zabij procesy blokujÄ…ce porty 5432 i 8080 jeÅ›li docker-compose down nie wystarczyÅ‚o
	@lsof -ti :5432 | xargs kill -9 2>/dev/null || true
	@lsof -ti :8080 | xargs kill -9 2>/dev/null || true

# Uruchomienie Å›rodowiska w tle
up: clean
	@echo "ğŸš€ Starting environment..."
	docker-compose up -d --build

# Czekanie aÅ¼ baza danych bÄ™dzie gotowa
wait-for-db:
	@echo "â³ Waiting for database to be ready..."
	@timeout=30; \
	while ! docker-compose exec -T db-service pg_isready -U postgres > /dev/null 2>&1; do \
		if [ $$timeout -le 0 ]; then \
			echo "âŒ Database failed to start within timeout"; \
			exit 1; \
		fi; \
		printf "."; \
		sleep 1; \
		timeout=$$((timeout-1)); \
	done; \
	echo "\nâœ… Database is ready!"

# Uruchomienie wszystkich testÃ³w (jednostkowe + integracyjne)
test: up wait-for-db
	@echo "ğŸ§ª Running tests..."
	go test ./... -v || (echo "âŒ Tests failed"; $(MAKE) clean; exit 1)
	@echo "âœ… All tests passed!"
	$(MAKE) clean
